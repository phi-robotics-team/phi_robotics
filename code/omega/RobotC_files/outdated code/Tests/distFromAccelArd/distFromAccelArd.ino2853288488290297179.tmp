#include <ADXL345.h>
#include <Wire.h>

ADXL345 accel;
int x = 0, y = 0, z = 0;
float gravityBias = 0;
float botAccel = 0, prevAccel = 0;
int deltaT = 0;
float velocity = 0, prevVelocity = 0, dist = 0, distDesired = 0;

int clockPin = 3, sigAPin = 4, sigBPin = 5;
bool checkAck = false;

int updateTimer = 0;
int deltaTimer = 0;

void setup() {
  reset();
  
  accel.powerOn();
  accel.readAccel(&x, &y, &z);
  updateTimer = millis();
  gravityBias = sqrt(x * x + y * y + z * z);
}

void loop() {
  if (digitalRead(clockPin) == LOW && digitalRead(sigAPin) == LOW)
  {
    digitalWrite(sigBPin, LOW);
    
    int place = 100;
    for (int i = 0; i < 5; i++)
    {
      int temp = 0;
      for (int j = 0; j < 2; j++)
      {
        while (digitalRead(clockPin) == LOW);
        
        pinMode(clockPin, OUTPUT);
        pinMode(sigAPin, INPUT);
        pinMode(sigBPin, INPUT);
        digitalWrite(clockPin, LOW);
        
        temp = (temp << 1) | pinLow(sigAPin);
        temp = (temp << 1) | pinLow(sigBPin);
        
        pinMode(clockPin, INPUT);
      }
      distDesired += temp * place;
      place /= 10;
    }
    
    pinMode(clockPin, INPUT);
    pinMode(sigAPin, INPUT);
    pinMode(sigBPin, INPUT);
  }
  
  while (dist < distDesired)
  {
    updateAccel();
    
    deltaT = (deltaTimer - micros()) * 0.000001;
    deltaTimer = micros();
    
    if (abs(botAccel < 0.01))
      botAccel = 0;
    
    velocity += deltaT/2 * (prevAccel + botAccel);
    dist += deltaT/2 * (prevVelocity + velocity);
    
    prevAccel = botAccel;
    prevVelocity = velocity;
    
    if (dist >= distDesired / 2)
    {
      pinMode(sigAPin, OUTPUT);
      digitalWrite(sigAPin, LOW);
      checkAck = true;
    }
      
    if (checkAck)
    {
      if (digitalRead(sigBPin) == LOW)
      {
        pinMode(sigAPin, INPUT);
        checkAck = false;
      }
    }
    
    delay(5);
  }
  
  pinMode(clockPin, OUTPUT);
  pinMode(sigAPin, OUTPUT);
  digitalWrite(clockPin, LOW);
  digitalWrite(sigAPin, LOW);
  
  while (digitalRead(sigBPin) == HIGH);
  
  reset();
}

void reset()
{
  dist = 0;
  distDesired = 0;
  checkAck = false;
  
  pinMode(clockPin, INPUT);
  pinMode(sigAPin, INPUT);
  pinMode(sigBPin, OUTPUT);
}

int pinLow(int pin)
{
  if (digitalRead(pin) == HIGH)
    return 1;
  else
    return 0;
}
void updateAccel()
{
  if ((millis() - updateTimer) > 5){  //Update only once per 5ms (200Hz update rate)
    accel.readAccel(&x, &y, &z);
    updateTimer = millis();
  }
  
  float vector = sqrt(x * x + y * y + z * z);
  botAccel = sqrt(vector * vector - gravityBias * gravityBias) * sign(x);
}

int sign(int n)
{
  if (n < 0)
    return -1;
  return 1;
}
